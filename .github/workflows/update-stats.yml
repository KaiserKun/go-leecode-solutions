name: Update LeetCode Stats

# Ensure the workflow has permission to update repository contents (push changes)
permissions:
  contents: write

on:
  push:
    paths:
      - "easy/**"
      - "medium/**"
      - "hard/**"
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  update-stats:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          # Use GH_PAT if available, otherwise fall back to GITHUB_TOKEN
          token: ${{ secrets.GH_PAT || secrets.GITHUB_TOKEN }}
          # ensure the action keeps credentials for pushing and fetches full history
          persist-credentials: true
          fetch-depth: 0

      - name: Count problems
        id: count
        run: |
          set -eux
          # ç»Ÿè®¡å„éš¾åº¦é¢˜ç›®æ•°é‡ï¼ˆæ’é™¤æµ‹è¯•æ–‡ä»¶ï¼‰
          EASY=$(find easy -type f -name "*.go" ! -name "*_test.go" 2>/dev/null | wc -l)
          MEDIUM=$(find medium -type f -name "*.go" ! -name "*_test.go" 2>/dev/null | wc -l)
          HARD=$(find hard -type f -name "*.go" ! -name "*_test.go" 2>/dev/null | wc -l)
          TOTAL=$((EASY + MEDIUM + HARD))

          echo "counts: easy=${EASY}, medium=${MEDIUM}, hard=${HARD}, total=${TOTAL}"

          # è®¡ç®—å›°éš¾é¢˜å æ¯”ï¼ˆä¿ç•™ä¸€ä½å°æ•°ï¼‰ï¼Œé¿å…é™¤é›¶
          if [ "$TOTAL" -eq 0 ]; then
            PERCENT="0.0"
          else
            PERCENT=$(awk "BEGIN{printf \"%.1f\", (${HARD}*100)/${TOTAL}}")
          fi

          echo "easy=$EASY" >> $GITHUB_OUTPUT
          echo "medium=$MEDIUM" >> $GITHUB_OUTPUT
          echo "hard=$HARD" >> $GITHUB_OUTPUT
          echo "total=$TOTAL" >> $GITHUB_OUTPUT
          echo "percent=$PERCENT" >> $GITHUB_OUTPUT

      - name: Update README.md (English)
        run: |
          set -eux
          EASY=${{ steps.count.outputs.easy }}
          MEDIUM=${{ steps.count.outputs.medium }}
          HARD=${{ steps.count.outputs.hard }}
          TOTAL=${{ steps.count.outputs.total }}
          PERCENT=${{ steps.count.outputs.percent }}

          # æ›´æ–°è‹±æ–‡ç‰ˆ README
          echo "--- README.md before ---"
          head -n 20 README.md || true

          # Update "X problems solved" line
          sed -i "s/\*\*[0-9]\+ problems solved\*\* ([0-9]\+ Easy \/ [0-9]\+ Medium \/ [0-9]\+ Hard)/**${TOTAL} problems solved** (${EASY} Easy \/ ${MEDIUM} Medium \/ ${HARD} Hard)/g" README.md

          # Update "Total: X problems" line
          sed -i "s/\*\*Total\*\*: [0-9]\+ problems/**Total**: ${TOTAL} problems/g" README.md

          # Update "Difficulty: X Easy / Y Medium / Z Hard" line
          sed -i "s/\*\*Difficulty\*\*: [0-9]\+ Easy \/ [0-9]\+ Medium \/ [0-9]\+ Hard/**Difficulty**: ${EASY} Easy \/ ${MEDIUM} Medium \/ ${HARD} Hard/g" README.md
          # Update "Difficulty: X Easy / Y Medium / Z Hard (P%)" line (include percentage)
          sed -i "s/^\s*- \*\*Difficulty\*\*:.*$/- **Difficulty**: ${EASY} Easy \/ ${MEDIUM} Medium \/ ${HARD} Hard (${PERCENT}%)/g" README.md

          echo "--- README.md after ---"
          head -n 20 README.md || true

      - name: Update README_CN.md (Chinese)
        run: |
          set -eux
          EASY=${{ steps.count.outputs.easy }}
          MEDIUM=${{ steps.count.outputs.medium }}
          HARD=${{ steps.count.outputs.hard }}
          TOTAL=${{ steps.count.outputs.total }}
          PERCENT=${{ steps.count.outputs.percent }}

          # æ›´æ–°ä¸­æ–‡ç‰ˆ README
          echo "--- README_CN.md before ---"
          head -n 20 README_CN.md || true

          # Update "å·²å®Œæˆ X é“" line
          sed -i "s/å·²å®Œæˆ \*\*[0-9]\+ é“\*\*ï¼ˆç®€å• [0-9]\+ \/ ä¸­ç­‰ [0-9]\+ \/ å›°éš¾ [0-9]\+ï¼‰/å·²å®Œæˆ **${TOTAL} é“**ï¼ˆç®€å• ${EASY} \/ ä¸­ç­‰ ${MEDIUM} \/ å›°éš¾ ${HARD}ï¼‰/g" README_CN.md

          # Update "æ€»é¢˜æ•°ï¼šX é“" line
          sed -i "s/\*\*æ€»é¢˜æ•°\*\*ï¼š[0-9]\+ é“/**æ€»é¢˜æ•°**ï¼š${TOTAL} é“/g" README_CN.md

          # Update "éš¾åº¦åˆ†å¸ƒï¼šç®€å• X / ä¸­ç­‰ Y / å›°éš¾ Z" line
          sed -i "s/\*\*éš¾åº¦åˆ†å¸ƒ\*\*ï¼šç®€å• [0-9]\+ \/ ä¸­ç­‰ [0-9]\+ \/ å›°éš¾ [0-9]\+/**éš¾åº¦åˆ†å¸ƒ**ï¼šç®€å• ${EASY} \/ ä¸­ç­‰ ${MEDIUM} \/ å›°éš¾ ${HARD}/g" README_CN.md
          # Update "éš¾åº¦åˆ†å¸ƒï¼šç®€å• X / ä¸­ç­‰ Y / å›°éš¾ Zï¼ˆå æ¯” P%ï¼‰" line (include percentage)
          sed -i "s/^\s*- \*\*éš¾åº¦åˆ†å¸ƒ\*\*ï¼š.*$/- **éš¾åº¦åˆ†å¸ƒ**ï¼šç®€å• ${EASY} \/ ${MEDIUM} \/ ${HARD}ï¼ˆå æ¯” ${PERCENT}%ï¼‰/g" README_CN.md

          echo "--- README_CN.md after ---"
          head -n 20 README_CN.md || true

      - name: Update Repository About Section
        run: |
          set -eux
          EASY=${{ steps.count.outputs.easy }}
          MEDIUM=${{ steps.count.outputs.medium }}
          HARD=${{ steps.count.outputs.hard }}
          TOTAL=${{ steps.count.outputs.total }}
          PERCENT=${{ steps.count.outputs.percent }}

          # æ„å»ºæ–°çš„æè¿°æ–‡æœ¬
          DESCRIPTION="LeetCode Solutions in Go - ${TOTAL} problems solved (${EASY} Easy / ${MEDIUM} Medium / ${HARD} Hard) | Rank: Top 51.77% | Contest Rating 1498"

          echo "Updating repository About with description: ${DESCRIPTION}"

          # è°ƒç”¨ GitHub API æ›´æ–° repo description å’Œ topics
          # æ³¨æ„ï¼šéœ€è¦ GH_PAT æˆ–å…·æœ‰è¶³å¤Ÿæƒé™çš„ GITHUB_TOKEN
          RESPONSE=$(curl -s -X PATCH \
            -H "Authorization: token ${{ secrets.GH_PAT || secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            https://api.github.com/repos/${{ github.repository }} \
            -d @- <<EOF
          {
            "description": "${DESCRIPTION}",
            "topics": ["leetcode", "go", "algorithms", "dsa", "problem-solving"]
          }
          EOF
          )

          echo "API Response: ${RESPONSE}"

          # æ£€æŸ¥å“åº”ä¸­æ˜¯å¦åŒ…å«é”™è¯¯
          if echo "${RESPONSE}" | grep -q '"message".*"Not Found"'; then
            echo "âš ï¸ Warning: Failed to update repository metadata. This may require a Personal Access Token (PAT) with 'repo' scope."
            echo "To fix: Add GH_PAT secret to your repository with appropriate permissions."
            exit 0
          fi

      - name: Commit and push changes
        run: |
          set -eux
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add README.md README_CN.md || true

          echo "git status:" 
          git status --porcelain=v1 -b || true
          echo "staged diff:" 
          git --no-pager diff --staged || true

          # If no changes, exit cleanly
          if git diff --staged --quiet; then
            echo "No changes to commit"
            exit 0
          fi

          # Commit with [skip ci] to prevent triggering this workflow again
          git commit -m "ğŸ“Š Auto update LeetCode stats [skip ci]"

          # Push directly to the current branch
          git push
