name: Update LeetCode Stats

# Ensure the workflow has permission to update repository contents (push changes)
permissions:
  contents: write

on:
  push:
    paths:
      - "easy/**"
      - "medium/**"
      - "hard/**"
  workflow_dispatch: # 允许手动触发

jobs:
  update-stats:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          # ensure the action keeps credentials for pushing and fetches full history
          persist-credentials: true
          fetch-depth: 0

      - name: Count problems
        id: count
        run: |
          set -eux
          # 统计各难度题目数量（排除测试文件）
          EASY=$(find easy -type f -name "*.go" ! -name "*_test.go" 2>/dev/null | wc -l)
          MEDIUM=$(find medium -type f -name "*.go" ! -name "*_test.go" 2>/dev/null | wc -l)
          HARD=$(find hard -type f -name "*.go" ! -name "*_test.go" 2>/dev/null | wc -l)
          TOTAL=$((EASY + MEDIUM + HARD))

          echo "counts: easy=${EASY}, medium=${MEDIUM}, hard=${HARD}, total=${TOTAL}"

          echo "easy=$EASY" >> $GITHUB_OUTPUT
          echo "medium=$MEDIUM" >> $GITHUB_OUTPUT
          echo "hard=$HARD" >> $GITHUB_OUTPUT
          echo "total=$TOTAL" >> $GITHUB_OUTPUT

      - name: Update README.md (English)
        run: |
          set -eux
          EASY=${{ steps.count.outputs.easy }}
          MEDIUM=${{ steps.count.outputs.medium }}
          HARD=${{ steps.count.outputs.hard }}
          TOTAL=${{ steps.count.outputs.total }}

          # 更新英文版 README
          echo "--- README.md before ---"
          head -n 20 README.md || true

          # Update "X problems solved" line
          sed -i "s/\*\*[0-9]\+ problems solved\*\* ([0-9]\+ Easy \/ [0-9]\+ Medium \/ [0-9]\+ Hard)/**${TOTAL} problems solved** (${EASY} Easy \/ ${MEDIUM} Medium \/ ${HARD} Hard)/g" README.md

          # Update "Total: X problems" line
          sed -i "s/\*\*Total\*\*: [0-9]\+ problems/**Total**: ${TOTAL} problems/g" README.md

          # Update "Difficulty: X Easy / Y Medium / Z Hard" line
          sed -i "s/\*\*Difficulty\*\*: [0-9]\+ Easy \/ [0-9]\+ Medium \/ [0-9]\+ Hard/**Difficulty**: ${EASY} Easy \/ ${MEDIUM} Medium \/ ${HARD} Hard/g" README.md

          echo "--- README.md after ---"
          head -n 20 README.md || true

      - name: Update README_CN.md (Chinese)
        run: |
          set -eux
          EASY=${{ steps.count.outputs.easy }}
          MEDIUM=${{ steps.count.outputs.medium }}
          HARD=${{ steps.count.outputs.hard }}
          TOTAL=${{ steps.count.outputs.total }}

          # 更新中文版 README
          echo "--- README_CN.md before ---"
          head -n 20 README_CN.md || true

          # Update "已完成 X 道" line
          sed -i "s/已完成 \*\*[0-9]\+ 道\*\*（简单 [0-9]\+ \/ 中等 [0-9]\+ \/ 困难 [0-9]\+）/已完成 **${TOTAL} 道**（简单 ${EASY} \/ 中等 ${MEDIUM} \/ 困难 ${HARD}）/g" README_CN.md

          # Update "总题数：X 道" line
          sed -i "s/\*\*总题数\*\*：[0-9]\+ 道/**总题数**：${TOTAL} 道/g" README_CN.md

          # Update "难度分布：简单 X / 中等 Y / 困难 Z" line
          sed -i "s/\*\*难度分布\*\*：简单 [0-9]\+ \/ 中等 [0-9]\+ \/ 困难 [0-9]\+/**难度分布**：简单 ${EASY} \/ 中等 ${MEDIUM} \/ 困难 ${HARD}/g" README_CN.md

          echo "--- README_CN.md after ---"
          head -n 20 README_CN.md || true

      - name: Commit changes and open PR
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -eux
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add README.md README_CN.md || true

          echo "git status:" 
          git status --porcelain=v1 -b || true
          echo "staged diff:" 
          git --no-pager diff --staged || true

          # If no changes, exit cleanly
          if git diff --staged --quiet; then
            echo "No changes to commit"
            exit 0
          fi

          git commit -m "📊 Auto update LeetCode stats"

          # Create a new branch and push it. Avoid pushing to protected branch.
          BRANCH="auto/update-stats-${GITHUB_RUN_ID}"
          BASE_BRANCH="${GITHUB_REF#refs/heads/}"

          # Create and checkout new branch
          git checkout -b "$BRANCH"

          # Push the new branch using the token for authentication
          git push -u origin "$BRANCH"

          # Create a pull request using GitHub CLI (more reliable than curl)
          echo "Creating PR from ${BRANCH} -> ${BASE_BRANCH}"
          
          EASY=${{ steps.count.outputs.easy }}
          MEDIUM=${{ steps.count.outputs.medium }}
          HARD=${{ steps.count.outputs.hard }}
          TOTAL=${{ steps.count.outputs.total }}
          
          gh pr create \
            --base "${BASE_BRANCH}" \
            --head "${BRANCH}" \
            --title "📊 Auto update LeetCode stats" \
            --body "This PR updates README.md and README_CN.md with the latest problem counts.

**Stats:**
- Easy: ${EASY}
- Medium: ${MEDIUM}
- Hard: ${HARD}
- Total: ${TOTAL}

Triggered by workflow run: ${GITHUB_RUN_ID}"
