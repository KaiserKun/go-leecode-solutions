name: Update LeetCode Stats

on:
  push:
    paths:
      - "easy/**"
      - "medium/**"
      - "hard/**"
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  update-stats:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          # ensure the action keeps credentials for pushing and fetches full history
          persist-credentials: true
          fetch-depth: 0

      - name: Count problems
        id: count
        run: |
          set -eux
          # ç»Ÿè®¡å„éš¾åº¦é¢˜ç›®æ•°é‡ï¼ˆæ’é™¤æµ‹è¯•æ–‡ä»¶ï¼‰
          EASY=$(find easy -type f -name "*.go" ! -name "*_test.go" 2>/dev/null | wc -l)
          MEDIUM=$(find medium -type f -name "*.go" ! -name "*_test.go" 2>/dev/null | wc -l)
          HARD=$(find hard -type f -name "*.go" ! -name "*_test.go" 2>/dev/null | wc -l)
          TOTAL=$((EASY + MEDIUM + HARD))

          echo "counts: easy=${EASY}, medium=${MEDIUM}, hard=${HARD}, total=${TOTAL}"

          echo "easy=$EASY" >> $GITHUB_OUTPUT
          echo "medium=$MEDIUM" >> $GITHUB_OUTPUT
          echo "hard=$HARD" >> $GITHUB_OUTPUT
          echo "total=$TOTAL" >> $GITHUB_OUTPUT

      - name: Update README.md (English)
        run: |
          set -eux
          EASY=${{ steps.count.outputs.easy }}
          MEDIUM=${{ steps.count.outputs.medium }}
          HARD=${{ steps.count.outputs.hard }}
          TOTAL=${{ steps.count.outputs.total }}

          # æ›´æ–°è‹±æ–‡ç‰ˆ README
          echo "--- README.md before ---"
          sed -n '1,120p' README.md || true

          sed -i "s/\*\*[0-9]* problems solved\*\* ([0-9]* Easy \/ [0-9]* Medium \/ [0-9]* Hard)/**${TOTAL} problems solved** (${EASY} Easy \/ ${MEDIUM} Medium \/ ${HARD} Hard)/g" README.md || true
          sed -i "s/Total\*\*: [0-9]* problems/Total**: ${TOTAL} problems/g" README.md || true
          sed -i "s/Difficulty\*\*: [0-9]* Easy \/ [0-9]* Medium \/ [0-9]* Hard/Difficulty**: ${EASY} Easy \/ ${MEDIUM} Medium \/ ${HARD} Hard/g" README.md || true

          echo "--- README.md after ---"
          sed -n '1,120p' README.md || true

      - name: Update README_CN.md (Chinese)
        run: |
          set -eux
          EASY=${{ steps.count.outputs.easy }}
          MEDIUM=${{ steps.count.outputs.medium }}
          HARD=${{ steps.count.outputs.hard }}
          TOTAL=${{ steps.count.outputs.total }}

          # æ›´æ–°ä¸­æ–‡ç‰ˆ README
          echo "--- README_CN.md before ---"
          sed -n '1,120p' README_CN.md || true

          sed -i "s/å·²å®Œæˆ \*\*[0-9]* é“\*\*ï¼ˆç®€å• [0-9]* \/ ä¸­ç­‰ [0-9]* \/ å›°éš¾ [0-9]*ï¼‰/å·²å®Œæˆ **${TOTAL} é“**ï¼ˆç®€å• ${EASY} \/ ä¸­ç­‰ ${MEDIUM} \/ å›°éš¾ ${HARD}ï¼‰/g" README_CN.md || true
          sed -i "s/æ€»é¢˜æ•°\*\*: [0-9]* é“/æ€»é¢˜æ•°**ï¼š${TOTAL} é“/g" README_CN.md || true
          sed -i "s/éš¾åº¦åˆ†å¸ƒ\*\*ï¼šç®€å• [0-9]* \/ ä¸­ç­‰ [0-9]* \/ å›°éš¾ [0-9]*/éš¾åº¦åˆ†å¸ƒ**ï¼šç®€å• ${EASY} \/ ä¸­ç­‰ ${MEDIUM} \/ å›°éš¾ ${HARD}/g" README_CN.md || true

          echo "--- README_CN.md after ---"
          sed -n '1,120p' README_CN.md || true

      - name: Commit changes
        run: |
          set -eux
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add README.md README_CN.md || true

          echo "git status:" 
          git status --porcelain=v1 -b || true
          echo "staged diff:" 
          git --no-pager diff --staged || true

          # Only commit if there are staged changes
          if ! git diff --staged --quiet; then
            git commit -m "ğŸ“Š Auto update LeetCode stats" || true
            # push to the current branch
            git push origin HEAD:${GITHUB_REF#refs/heads/} || true
          else
            echo "No changes to commit"
          fi
